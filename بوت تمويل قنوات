import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, CallbackQueryHandler,
    MessageHandler, ContextTypes, filters
)

TOKEN = os.getenv)(8173525918:AAGqQk81wqLpz2bs0P4E_oq4pfRIPxA9Ve4)
ADMIN_ID = int(os.getenv("ADMIN_ID", "0"))
CHANNEL_USERNAME = "@noooralhoda50"
CHANNEL_LINK = "https://t.me/noooralhoda50"

funding_open = True
pending = {}

# ===== ÙØ­Øµ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ =====
async def is_subscribed(bot, user_id):
    try:
        member = await bot.get_chat_member(https://t.me/noooralhoda50, user_id)
        return member.status in ("member", "administrator", "creator")
    except:
        return False

async def force_subscribe(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ğŸ“£ Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©", url=CHANNEL_LINK)],
        [InlineKeyboardButton("âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="check_sub")]
    ]
    await update.message.reply_text(
        "ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ===== /start =====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    if not await is_subscribed(context.bot, user_id):
        await force_subscribe(update, context)
        return

    keyboard = [
        [InlineKeyboardButton("ğŸ’° ØªÙ…ÙˆÙŠÙ„", callback_data="fund")],
        [InlineKeyboardButton("ğŸ“ ØªÙˆØ§ØµÙ„", callback_data="contact")],
        [InlineKeyboardButton("â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", callback_data="info")]
    ]
    await update.message.reply_text(
        "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªÙ…ÙˆÙŠÙ„",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ===== ØªØ­Ù‚Ù‚ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ =====
async def check_sub(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    if await is_subscribed(context.bot, q.from_user.id):
        await q.message.delete()
        await start(Update(update.update_id, message=q.message), context)
    else:
        await q.message.reply_text("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø¹Ø¯")

# ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± =====
async def buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global funding_open
    q = update.callback_query
    await q.answer()

    if q.data == "fund":
        if not funding_open:
            await q.message.reply_text("â›” Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ù…Ù‚ÙÙˆÙ„ Ø­Ø§Ù„ÙŠÙ‹Ø§")
            return
        await q.message.reply_text("ğŸ’µ Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº Ø§Ù„ØªÙ…ÙˆÙŠÙ„:")
        context.user_data["step"] = "amount"

    elif q.data == "contact":
        await q.message.reply_text("ğŸ“ Ø§Ù„Ø£Ø¯Ù…Ù†: @USERNAME")

    elif q.data == "info":
        await q.message.reply_text("â„¹ï¸ Ø¨ÙˆØª Ù…Ø®ØµØµ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„Ø§Øª")

# ===== Ù†ØµÙˆØµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if context.user_data.get("step") == "amount":
        amount = update.message.text
        context.user_data["amount"] = amount
        context.user_data["step"] = "photo"
        await update.message.reply_text(
            "ğŸ’³ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹:\n"
            "ğŸ“± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´: 010XXXXXXX\n"
            "ğŸ¦ Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ: instapay@name\n\n"
            "ğŸ“¸ Ø§Ø¨Ø¹Øª Ø³ÙƒØ±ÙŠÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„"
        )

# ===== ØµÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    amount = context.user_data.get("amount", "ØºÙŠØ± Ù…Ø­Ø¯Ø¯")
    pending[user.id] = {"user": user.username, "amount": amount}

    keyboard = [
        [InlineKeyboardButton("âœ… Ù‚Ø¨ÙˆÙ„", callback_data=f"ok_{user.id}"),
         InlineKeyboardButton("âŒ Ø±ÙØ¶", callback_data=f"no_{user.id}")]
    ]

    await context.bot.send_message(
        chat_id=ADMIN_ID,
        text=f"ğŸ“¥ ØªÙ…ÙˆÙŠÙ„ Ø¬Ø¯ÙŠØ¯\nğŸ‘¤ @{user.username}\nğŸ’µ {amount}",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    await context.bot.forward_message(
        chat_id=ADMIN_ID,
        from_chat_id=update.message.chat_id,
        message_id=update.message.message_id
    )

    await update.message.reply_text("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø£Ø¯Ù…Ù†")

# ===== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù† =====
async def admin_actions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    action, user_id = q.data.split("_")
    user_id = int(user_id)

    data = pending.get(user_id)
    if not data:
        return

    if action == "ok":
        await context.bot.send_message(
            chat_id=user_id,
            text="âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ø¯Ø¹Ù…Ùƒ â¤ï¸"
        )
        with open("funding_log.txt", "a", encoding="utf-8") as f:
            f.write(f"{data['user']} | {data['amount']} | Ù…Ù‚Ø¨ÙˆÙ„\n")
    else:
        await context.bot.send_message(
            chat_id=user_id,
            text="âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„ØªÙ…ÙˆÙŠÙ„"
        )

    pending.pop(user_id)

async def close_funding(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global funding_open
    if update.message.from_user.id == ADMIN_ID:
        funding_open = False
        await update.message.reply_text("ğŸ”’ ØªÙ… Ù‚ÙÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„")

async def open_funding(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global funding_open
    if update.message.from_user.id == ADMIN_ID:
        funding_open = True
        await update.message.reply_text("ğŸ”“ ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ…ÙˆÙŠÙ„")

# ===== MAIN =====
def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("close", close_funding))
    app.add_handler(CommandHandler("open", open_funding))
    app.add_handler(CallbackQueryHandler(admin_actions, pattern="^(ok|no)_"))
    app.add_handler(CallbackQueryHandler(check_sub, pattern="check_sub"))
    app.add_handler(CallbackQueryHandler(buttons))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    app.run_polling()

if __name__ == "__main__":
    main()
